{% extends "base.html" %}

{% block title %}Step 1: Upload Fingerprint{% endblock %}

{% block content %}
<style>
    /* CSS for the scanning animation */
    .scanning-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7); /* Semi-transparent dark overlay */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000; /* Ensure it's on top */
        color: white;
        text-align: center;
        transition: opacity 0.3s ease-in-out;
        opacity: 0; /* Hidden by default */
        pointer-events: none; /* Allows clicks to pass through when hidden */
    }

    .scanning-overlay.active {
        opacity: 1; /* Visible when active */
        pointer-events: all; /* Blocks clicks when active */
    }

    .scanner-line {
        position: absolute;
        width: 80%;
        height: 3px; /* Thickness of the line */
        background: linear-gradient(to right, transparent, #00ff00, transparent); /* Green scanning light */
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
        animation: scan-animation 2s infinite alternate ease-in-out; /* Scanning animation */
        border-radius: 5px;
    }

    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #00ff00; /* Green spinner */
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes scan-animation {
        0% { top: 10%; }
        100% { top: 90%; }
    }

    /* Styles for image container and preview */
    .fingerprint-preview-container {
        position: relative; /* Needed for absolute positioning of overlay */
        width: 250px; /* Fixed width for preview area */
        height: 250px; /* Fixed height for preview area */
        border: 2px dashed #4a5568; /* Tailwind gray-700 */
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden; /* Hide overflow from image */
        margin: 20px auto;
        border-radius: 8px;
        background-color: #2d3748; /* Tailwind gray-800 */
    }

    .fingerprint-preview-img {
        max-width: 100%;
        max-height: 100%;
        display: block;
        object-fit: contain; /* Ensure image fits without cropping */
    }
</style>

<div class="relative min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8"
     style="background-image: url('{{ url_for('static', filename='img/bg.png') }}'); background-size: cover; background-position: center;">

    {# The main prompt/card container with dual-color background #}
    <div class="relative z-10 p-8 rounded-lg shadow-lg max-w-xl w-full text-center overflow-hidden"
         style="background: linear-gradient(to right, #6a5acd, #ff69b4);"> {# Adjusted colors for purple to pink gradient #}
        
        <h2 class="text-3xl font-bold text-white mb-6">Step 1: Upload Fingerprint</h2>
        <div class="note bg-blue-100 bg-opacity-80 border-l-4 border-blue-500 text-blue-900 p-4 mb-6 rounded-md">
            <strong>Note:</strong> Upload a fingerprint image to extract its type and ridge count. You must be logged in to proceed.
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="list-none p-0 mx-auto max-w-lg">
                {% for category, message in messages %}
                    <li class="flash-message flash-{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        {# Display errors coming from AJAX response #}
        <div id="ajax-error-message" class="error hidden text-red-700 bg-red-100 p-3 rounded-md mb-4"></div>


        <form id="fingerprint-upload-form" method="POST" enctype="multipart/form-data" action="{{ url_for('extract_features_ajax') }}">
            <div class="form-group mb-4">
                <label for="fingerprint_image" class="block text-white text-sm font-bold mb-2">Upload Fingerprint Image (.bmp, .png, etc.):</label>
                <input type="file" id="fingerprint_image" name="fingerprint_image" accept=".bmp,.png,.jpg,.jpeg,.gif" required
                       class="block w-full text-sm text-gray-800 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>

            <div class="fingerprint-preview-container bg-gray-700 bg-opacity-50"> {# Adjusted preview container background #}
                <img id="image-preview" class="fingerprint-preview-img" src="#" alt="Fingerprint Preview" style="display: none;">
                <p id="preview-placeholder" class="text-gray-200">Image Preview Here</p>
                <div id="scanning-overlay" class="scanning-overlay">
                    <div class="spinner"></div>
                    <p class="text-lg font-bold mb-4">Scanning Fingerprint...</p>
                    <div class="scanner-line"></div>
                </div>
            </div>

            <button type="submit" id="extract-features-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                Extract Features
            </button>
        </form>

        <div id="extracted-features-display" class="extracted-info bg-green-100 bg-opacity-80 border-l-4 border-green-500 text-green-900 p-4 mt-6 rounded-md hidden">
            <h3 class="text-xl font-semibold text-green-800 mb-3">Extracted Fingerprint Data:</h3>
            <p class="mb-2"><strong>Fingerprint Type:</strong> <span id="display-fingerprint-type" class="font-medium"></span></p>
            <p><strong>Ridge Count:</strong> <span id="display-ridge-count" class="font-medium"></span></p>
            <form action="{{ url_for('show_prediction_form') }}" method="GET" class="mt-4">
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                    Proceed to Prediction
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fingerprintImageInput = document.getElementById('fingerprint_image');
        const imagePreview = document.getElementById('image-preview');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const uploadForm = document.getElementById('fingerprint-upload-form');
        const extractFeaturesBtn = document.getElementById('extract-features-btn');
        const scanningOverlay = document.getElementById('scanning-overlay');
        const extractedFeaturesDisplay = document.getElementById('extracted-features-display');
        const displayFingerprintType = document.getElementById('display-fingerprint-type');
        const displayRidgeCount = document.getElementById('display-ridge-count');
        const ajaxErrorMessage = document.getElementById('ajax-error-message');

        // Function to show/hide error message
        function showErrorMessage(message) {
            ajaxErrorMessage.textContent = message;
            ajaxErrorMessage.classList.remove('hidden');
        }

        function hideErrorMessage() {
            ajaxErrorMessage.classList.add('hidden');
        }

        // Image preview functionality
        fingerprintImageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    previewPlaceholder.style.display = 'none';
                    // Hide previous results/errors when a new file is selected
                    extractedFeaturesDisplay.classList.add('hidden');
                    hideErrorMessage();
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = '#';
                imagePreview.style.display = 'none';
                previewPlaceholder.style.display = 'block';
            }
        });

        // AJAX Form Submission for feature extraction
        uploadForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission (page reload)

            hideErrorMessage(); // Clear previous errors
            extractedFeaturesDisplay.classList.add('hidden'); // Hide previous results

            // Show scanning animation
            scanningOverlay.classList.add('active');
            extractFeaturesBtn.disabled = true; // Disable button during scan
            extractFeaturesBtn.textContent = 'Processing...';

            const formData = new FormData(uploadForm);

            fetch(uploadForm.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    // If HTTP status is not 2xx, throw an error
                    return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    displayFingerprintType.textContent = data.fingerprint_type.charAt(0).toUpperCase() + data.fingerprint_type.slice(1);
                    displayRidgeCount.textContent = data.ridge_count;
                    extractedFeaturesDisplay.classList.remove('hidden'); // Show results
                } else {
                    showErrorMessage(data.error || 'Unknown error occurred.');
                }
            })
            .catch(error => {
                console.error('Extraction Error:', error);
                showErrorMessage('Failed to extract features: ' + error.message);
            })
            .finally(() => {
                // Hide scanning animation
                scanningOverlay.classList.remove('active');
                extractFeaturesBtn.disabled = false; // Re-enable button
                extractFeaturesBtn.textContent = 'Extract Features';
            });
        });
    });
</script>
{% endblock %}